<!-- src/app/activos/pages/activo-page/activo-page.component.html -->

<!-- Header de la pÃ¡gina -->
<div class="page-header">
  <h2>AssetFlow - GestiÃ³n de Activos</h2>
  <button 
    class="btn btn-primary" 
    (click)="abrirFormularioCreacion()"
    [disabled]="cargando">
    <span>â•</span> Nuevo Activo
  </button>
</div>

<!-- Indicador de carga -->
<div *ngIf="cargando" class="loading-overlay">
  <div class="spinner"></div>
  <p>Cargando activos...</p>
</div>

<!-- Mensaje de error global -->
<div *ngIf="errorCarga" class="alert alert-danger">
  <strong>âš ï¸ Error de ConexiÃ³n</strong>
  <p>No se pudo conectar con la API del Backend.</p>
  <button class="btn btn-sm btn-outline-danger" (click)="recargarActivos()">
    ğŸ”„ Reintentar
  </button>
</div>

<!-- Mensajes al usuario (Ã©xito/error) -->
<div 
  *ngIf="mensajeUsuario" 
  class="alert"
  [ngClass]="{
    'alert-success': tipoMensaje === 'success',
    'alert-danger': tipoMensaje === 'error',
    'alert-info': tipoMensaje === 'info'
  }"
  role="alert">
  <span 
    class="close-btn" 
    (click)="cerrarMensaje()"
    title="Cerrar">
    âœ•
  </span>
  <div style="white-space: pre-line;">{{ mensajeUsuario }}</div>
</div>

<!-- Contenedor principal con datos -->
<div *ngIf="!cargando">
  
  <!-- Caso: Lista vacÃ­a (sin filtros aplicados) -->
  <div *ngIf="(activos$ | async)?.length === 0" class="empty-state">
    <div class="empty-icon">ğŸ“¦</div>
    <h3>No hay activos registrados</h3>
    <p>Comience agregando su primer activo al sistema.</p>
    <button class="btn btn-primary" (click)="abrirFormularioCreacion()">
      â• Crear Primer Activo
    </button>
  </div>

  <!-- Caso: Hay datos -->
  <div *ngIf="(activos$ | async)?.length! > 0">
    
    <!-- Filtros -->
    <div class="filtros-container">
      <input 
        type="text" 
        class="form-control" 
        placeholder="ğŸ” Buscar activo..."
        #searchInput
        (input)="filtrarActivos(searchInput.value)">
      
      <select 
        class="form-control"
        #categoriaSelect
        (change)="filtrarPorCategoria(categoriaSelect.value)">
        <option value="">Todas las categorÃ­as</option>
        <option 
          *ngFor="let categoria of categorias$ | async" 
          [value]="categoria.id">
          {{ categoria.nombre }}
        </option>
      </select>

      <select 
        class="form-control"
        #estadoSelect
        (change)="filtrarPorEstado(estadoSelect.value)">
        <option value="">Todos los estados</option>
        <option value="AC">Activo</option>
        <option value="MA">En Mantenimiento</option>
        <option value="DB">Dado de Baja</option>
        <option value="RE">En ReparaciÃ³n</option>
      </select>

      <button 
        class="btn btn-secondary"
        (click)="limpiarFiltros(); searchInput.value=''; categoriaSelect.value=''; estadoSelect.value=''">
        ğŸ—‘ï¸ Limpiar Filtros
      </button>
    </div>

    <!-- Resumen con activos filtrados -->
    <div class="summary-cards" *ngIf="activosFiltrados$ | async as activosFiltrados">
      <div class="summary-card">
        <div class="summary-icon">ğŸ“Š</div>
        <div class="summary-content">
          <span class="summary-label">Total Activos</span>
          <span class="summary-value">{{ activosFiltrados.length }}</span>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="summary-icon">ğŸ’°</div>
        <div class="summary-content">
          <span class="summary-label">Valor Total</span>
          <span class="summary-value">
            {{ calcularValorTotal(activosFiltrados) | currency:'USD':'symbol':'1.2-2' }}
          </span>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon">âœ…</div>
        <div class="summary-content">
          <span class="summary-label">Activos Activos</span>
          <span class="summary-value">
            {{ (contarPorEstado(activosFiltrados))['AC'] || 0 }}
          </span>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon">ğŸ”§</div>
        <div class="summary-content">
          <span class="summary-label">En Mantenimiento</span>
          <span class="summary-value">
            {{ (contarPorEstado(activosFiltrados))['MA'] || 0 }}
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla de activos (usa lista filtrada) -->
    <div *ngIf="activosFiltrados$ | async as activosFiltrados">  
      
      <!-- Caso: Filtros activos pero sin resultados -->
      <div *ngIf="activosFiltrados.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <h3>No hay activos que coincidan con los filtros</h3>
        <p>Intente ajustar o limpiar los filtros para ver mÃ¡s resultados.</p>
        <button 
          class="btn btn-secondary" 
          (click)="limpiarFiltros(); searchInput.value=''; categoriaSelect.value=''; estadoSelect.value=''">
          ğŸ—‘ï¸ Limpiar Filtros
        </button>
      </div>

      <!-- Caso: Hay resultados filtrados -->
      <div *ngIf="activosFiltrados.length > 0">
        <app-lista-tabla 
          [datos]="activosFiltrados"
          (itemEliminado)="manejarEliminacion($event)"
          (itemEditado)="manejarEdicion($event)">
        </app-lista-tabla>
      </div>
      
    </div>
  </div>
</div>

<!-- Modal de formulario -->
<div *ngIf="mostrarFormulario" class="modal-overlay" (click)="cerrarFormulario()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Activo: ' + activoAEditar?.nombre : 'Nuevo Activo' }}</h3>
      <button class="close-btn" (click)="cerrarFormulario()">âœ•</button>
    </div>
    <div class="modal-body">
      <app-activo-form
        [activoInicial]="activoAEditar"
        [categorias]="(categorias$ | async) || []"
        (activoGuardado)="manejarGuardado($event)"
        (cancelar)="cerrarFormulario()">
      </app-activo-form>
    </div>
  </div>
</div>